<html>
    <head>
        <link rel="stylesheet" href="/static/css/base.css">
        <link rel="stylesheet" href="/static/css/bootstrap.min.css">
        {{ fontawesome_css() }}
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{{ game.name }}</title>
        <script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
        <script src="/static/js/bootstrap.min.js"></script>
    </head>
    <body>
      <div class="game container-xl rounded">
        <nav class="navbar navbar-light bg-dark rounded panel">
          <span id="game-name" class="navbar-brand mb-0 h1">{{ game.name }}</span>
          <div class="btn-group btn-group-toggle" data-toggle="buttons">
            <label class="btn btn-secondary active">
              <input type="radio" name="light-mode" id="activate-light-mode" autocomplete="off" checked>
                <i class="fas fa-sun"></i>
            </label>
            <label class="btn btn-secondary">
              <input type="radio" name="dark-mode" id="activate-dark-mode" autocomplete="off">
              <i class="fas fa-moon"></i>
            </label>
          </div>
        </nav>

        <div class="game-area row">
            <div class="game-log-container col rounded panel">
                <b>Game log</b>
                <div id="game-log"></div>
                <form id="send_message" class="input-group" method="POST" action='#'>
                    <div class="input-group mb-3">
                      <input type="text" class="form-control" name="message_content" id="message_content" placeholder="Message">
                      <div class="input-group-append">
                        <button id="send_message_button" class="btn btn-secondary btn-sm" type="submit">
                            <span class="fas fa-paper-plane"></span>
                        </button>
                      </div>
                    </div>
                </form>
            </div>
            <div class="col-6 scoreboard rounded panel">
                {% for player in other_players %}
                    <div id="{{ player.nickname }}" class="scoreboard-player-area">
                        <h5 class="player-nickname">{{ player.nickname }}</h5>
                        <h6 class="player-points">{{ player.points }}</h6>
                    </div>
                {% endfor %}
            </div>
            <div class="col deck-area rounded panel">
                <div id="deck">
                    <img src="/static/img/cards/deck.png" width="100px" />
                </div>
            </div>
        </div>

        <div class="player-area row rounded panel">
            <div class="game-alert alert alert-info alert-dismissable">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            </div>

            <div class="col">
                <button id="action-button" type="button" class="btn btn-dark btn-lg">Deal Hands</button>
            </div>
            <div class="col-6">
                <div id="{{ player.nickname }}">
                    <h5 class="player-nickname">{{ player.nickname }}</h5>
                    <h6 class="player-points">{{ player.points }}</h6>
                    <ul id="{{ player.nickname }}-cards" class="list-group-flush list-group-horizontal">
                    </ul>
                </div>
            </div>
            <div class="col">
                <form id="leave" method="POST" action='/'>
                    <button type="submit" class="btn btn-outline-danger">Leave game</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function() {
          // Use a "/test" namespace.
          // An application can open a connection on multiple namespaces, and
          // Socket.IO will multiplex all those connections on a single
          // physical channel. If you don't care about multiple channels, you
          // can set the namespace to an empty string.
          namespace = '/game';

          // Connect to the Socket.IO server.
          // The connection URL has the following format, relative to the current page:
          //     http[s]://<domain>:<port>[/<namespace>]
          var socket = io(namespace);

          if (sessionStorage.getItem("gameName") !== null && sessionStorage.getItem("nickname") !== null) {
            socket.emit('join', {game: sessionStorage.getItem('gameName'), nickname: sessionStorage.getItem('nickname')});
          }

          // join game
          socket.on('player_join', function (msg, cb) {
            if ($("#" + msg.nickname).length == 0) {
              let playerDiv = $('<div/>', {
                id: msg.nickname,
                class: 'scoreboard-player-area',
                html: '<h5 class="player-name">' + msg.nickname + '</h5><h6 class="player-score">' + 0 + '</h6>'
              });
              $('.scoreboard').append(playerDiv);
              $('#game-log').append('<br>' + $('<div/>').text(msg.nickname + ' joined.').html());
            }
          });


          // leave game
          $('form#leave').submit(function(event) {
              let nickname = sessionStorage.getItem("nickname");
              let gameName = sessionStorage.getItem("gameName");
              socket.emit('leave', {game: gameName, nickname: nickname});
              sessionStorage.removeItem('nickname');
              sessionStorage.removeItem('gameName');
              window.location.href = "/";
          });

          socket.on('player_leave', function (msg, cb) {
            $("#player-" + msg.nickname).remove();
            $('#game-log').append('<br>' + $('<div/>').text(msg.nickname + ' left.').html());
          });


          // send message
          $('form#send_message').submit(function(event) {
            console.log('here!');
            let nickname = sessionStorage.getItem("nickname");
            let gameName = sessionStorage.getItem("gameName");
            socket.emit('send_message', {
              game: gameName, nickname: nickname, data: $('#message_content').val()});
            return false;
          });
          socket.on('new_chat_message', function(msg, cb) {
            $('#game-log').append('<br>' + $('<div/>').text(msg.nickname + ': ' + msg.data).html());
            if (cb)
              cb();
          });


        // deal card
        socket.on('deal_hands', function (msg, cb) {
          $.each(msg.hands, function(player, cards) {
            if (player === sessionStorage.getItem('nickname')) {
                let card_ids = []
                $.each(cards, function(index, card) {
                  let cardImage = $('<img/>', {
                    id: card['id'],
                    class: 'playerCard',
                    src: '/static/img' + card['image']
                  });
                  let cardListItem = $('<li/>', {
                    class: 'list-group-item',
                  });
                  cardListItem.append(cardImage)
                  $('#' + player + '-cards').append(cardListItem);
                  card_ids.push(card['id'])
                });
                sessionStorage.setItem('card_ids', JSON.stringify(card_ids))
            } else {
              $.each(cards, function(index, card) {
                let cardImage = $('<img/>', {
                  id: card['id'],
                  class: 'opponentCard',
                  src: '/static/img/cards/facedown.png'
                });
                $('#' + player).append(cardImage);
              });
            }
          });
          $('#action-button').html('Discard');
          $('#action-button').prop('disabled', true);
          socket.emit('send_message', {game: sessionStorage.getItem('gameName'), nickname: 'cribbot', data: 'Time to discard!'});
          // gameAlert('Time to discard 2 cards from your hand.');
        });

        // handle discard from sever
        socket.on('post_discard', function (msg, cb) {
          console.log('HERE I AM!')
          $('#' + msg.discarded).parent().remove();
          let card_ids = JSON.parse(sessionStorage.getItem('card_ids'));
          card_ids.splice( $.inArray(msg.discarded, card_ids), 1 );
          sessionStorage.setItem('card_ids', JSON.stringify(card_ids))
        });


        $('#action-button').click(function (event) {
          let gameName = sessionStorage.getItem("gameName");
          let playerName = sessionStorage.getItem("nickname");
          if ($(this).text() === 'Deal Hands') {
            socket.emit('deal_hands', {game: gameName});
          } else if ($(this).text() === 'Discard') {
            let cardId = $('li.list-group-item.active').children()[0].id;
            console.log('cardId: ' + cardId);
            socket.emit('discard', {game: gameName, nickname: playerName, cardId: cardId});
          }
          return false;
        });

        $('#activate-dark-mode').click(function (event) {
            $('body').attr('style', 'background-color: #000000 !important');
            $('.game').css({"background-color":"#000000", "color": "#F5F5F5"});
            $('.panel').css({"background-color": "#343a40", "border": "1px solid #8B7B8B"});
        });
        $('#activate-light-mode').click(function (event) {
            $("body").css({"background-color":"#344152"});
            $('.game').css({"background-color":"#344152", "color": "#F5F5F5"});
            $('.panel').css({"background-color": "#343a40", "border": "1px solid #404040"});
        });

      });

      $(document).on('click', 'li.list-group-item', function(e) {
        $(this).toggleClass('active');
        if ($(this).hasClass('active')) {
          $('#action-button').prop('disabled', false);
        } else if($(this).siblings(".active").length == 0) {
          $('#action-button').prop('disabled', true);
        }
      });

      function gameAlert(text){
          $(".game-alert").html(text).show();
          // setTimeout(function(){
          //   $(".game-alert").hide();
          // }, 5000);
        }
    </script>
    </body>
</html>