<html>
    <head>
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
        <link rel="stylesheet" href="/static/css/base.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Lobby</title>
        <script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="pure-g">
            <div class="pure-u-1-4"></div>
            <div class="pure-u-1-2 lobby">
                <div class="pure-form">
                    <img src="/static/img/logo.png" />
                    <form id="join" method="POST" action='#'>
                        <input type="text" name="join_nickname" id="join_nickname" placeholder="nickname">
                        <input type="text" name="join_game_name" id="join_game_name" placeholder="game name">
                        <input type="submit" value="Join Game">
                    </form>
                </div>
            </div>

            <div class="pure-u-1-4 game">
                <form id="leave" method="POST" action='#'>
                    <input type="submit" value="Leave Game">
                </form>
                <form id="send_message" method="POST" action='#'>
                    <input type="text" name="game_data" id="game_data" placeholder="Message">
                    <input type="submit" value="Send">
                </form>
                <h2>Game log:</h2>
                <div id="log"></div>
            </div>

        </div>

        <script type="text/javascript" charset="utf-8">
        $(document).ready(function() {
          // Use a "/test" namespace.
          // An application can open a connection on multiple namespaces, and
          // Socket.IO will multiplex all those connections on a single
          // physical channel. If you don't care about multiple channels, you
          // can set the namespace to an empty string.
          namespace = '/game';

          // Connect to the Socket.IO server.
          // The connection URL has the following format, relative to the current page:
          //     http[s]://<domain>:<port>[/<namespace>]
          var socket = io(namespace);

          // join game
          $('form#join').submit(function (event) {
            let nickname = $('#join_nickname').val();
            let gameName = $('#join_game_name').val();
            sessionStorage.setItem('nickname', nickname);
            sessionStorage.setItem('gameName', gameName);
            socket.emit('join', {game: gameName, nickname: nickname});
            return false;
          });

          socket.on('player_join', function (msg, cb) {
            $('.game').show();
            $('.lobby').hide();
            socket.emit('player_action_announcement', {
              game: msg.gameName, nickname: msg.nickname, action: 'joined' });
          });

          socket.on('player_action_announcement', function(msg, cb) {
            $('#log').append('<br>' + $('<div/>').text(msg.data).html());
          });


          // leave game
          $('form#leave').submit(function(event) {
              let nickname = sessionStorage.getItem("nickname");
              let gameName = sessionStorage.getItem("gameName");
              socket.emit('leave', {game: gameName, nickname: nickname});
              return false;
          });

          socket.on('player_leave', function (msg, cb) {
            $('.game').hide();
            $('.lobby').show();
            socket.emit('player_action_announcement', {
              game: msg.gameName, nickname: msg.nickname, action: 'left' });
          });


          // send message
          $('form#send_message').submit(function(event) {
            let nickname = sessionStorage.getItem("nickname");
            let gameName = sessionStorage.getItem("gameName");
            socket.emit('send_message', {
              game: gameName, nickname: nickname, data: $('#game_data').val()});
            return false;
          });
          socket.on('new_chat_message', function(msg, cb) {
            $('#log').append('<br>' + $('<div/>').text(msg.nickname + ': ' + msg.data).html());
            if (cb)
              cb();
          });

        });

        </script>
    </body>
</html>
